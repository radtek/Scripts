17:52:51 pceudb25>@scriptobject
Owner......:prous_web_content
Object_type:PACKAGE
Object_name:pk_load_global
antigo   1: select dbms_metadata.get_ddl (upper(replace('&typ', ' ', '_')) ,  upper('&nam'), upper('&sch')) AS DDL from dual
novo   1: select dbms_metadata.get_ddl (upper(replace('PACKAGE', ' ', '_')) ,  upper('pk_load_global'), upper('prous_web_content')) AS DDL from dual
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  CREATE OR REPLACE PACKAGE "PROUS_WEB_CONTENT"."PK_LOAD_GLOBAL" is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  --                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  -- Procedimiento que analiza una única tabla                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  --                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  procedure analizaTabla (p_owner in varchar2, p_tableName in varchar2);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  procedure util_log (p_action varchar2, p_lpe_id varchar2, p_lpe_subsystem varchar2, p_lpe_status varchar2);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  procedure util_analyze_pr;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  procedure util_exception_pr(	p_rowid rowid,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  								p_owner varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  								p_table varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  								p_code	number,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  								p_msg	varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  								p_id	number);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
CREATE OR REPLACE PACKAGE BODY "PROUS_WEB_CONTENT"."PK_LOAD_GLOBAL" is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
-- Procedimiento que analiza una única tabla                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
--                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
procedure analizaTabla (p_owner in varchar2, p_tableName in varchar2) is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
      dbms_stats.gather_table_stats(ownname => p_owner,tabname => p_tableName,estimate_percent => 20,cascade => true);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
      dbms_stats.gather_table_stats(ownname => p_owner,tabname => p_tableName,estimate_percent => 20,method_opt => 'FOR ALL INDEXED COLUMNS',cascade => false);                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
end analizaTabla;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
procedure util_log (p_action varchar2, p_lpe_id varchar2, p_lpe_subsystem varchar2, p_lpe_status varchar2) is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  if p_action = 'I' then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
      insert into log_processes(lpe_id, lpe_start, lpe_subsystem, lpe_status)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
      values(p_lpe_id, sysdate,p_lpe_subsystem,p_lpe_status);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
  elsif p_action ='U' then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
      update log_processes set lpe_status = p_lpe_status where lpe_id = p_lpe_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
  end if;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  commit;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
procedure util_analyze_pr is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
	cursor c_tables is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  	select table_name, owner                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
  		from all_tables                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
  		where owner in ('PROUS_EDITORIAL_CONTENT','CRT_OWNER','PROUS_WEB_CONTENT')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
  		and table_name not like 'DR$CTX_%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
      and table_name not like 'OM_%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
      and table_name not like 'SMP_%'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
      and table_name not like 'CTL_%';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
	v_lpe_id number;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
--  select seq_log_processes.nextval into v_lpe_id from dual;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
--  pk_load_global.util_log ('I', v_lpe_id, 'GLO','ANALYZE');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  for v in c_tables loop                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
    begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
      analizaTabla(p_owner => v.owner, p_tableName => v.table_name);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
/*    exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
      when others then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
      util_exception_pr(p_rowid => null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
        								p_owner => null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
        								p_table => 'analyze table',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
        								p_code	=> sqlcode,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        								p_msg	  => 'Table: '||v.table_name||' ==> '|| sqlerrm,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
        								p_id	  => null);*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
    end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
  end loop;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
--  select seq_log_processes.nextval into v_lpe_id from dual;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
--  pk_load_global.util_log ('I', v_lpe_id, 'GLO','FIN ANALYZE');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  exception                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
    when others then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
      null;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
-- Tratamiento de excepcion                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
procedure util_exception_pr(	p_rowid rowid,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                p_owner varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                p_table varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                p_code	number,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                p_msg	varchar2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                p_id	number) is                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  insert into log_exceptions(row_id, owner, table_name, err_code, err_message, id, err_date)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  values(p_rowid, p_owner, upper(p_table), p_code, p_msg, p_id, sysdate);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
  COMMIT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
17:53:10 pceudb25>
17:53:32 pceudb25>
17:53:32 pceudb25>
17:53:32 pceudb25>
17:53:33 pceudb25>
17:53:33 pceudb25>spool off
